# Grocery Scraper API

A professional FastAPI service for scraping real-time grocery store product data with location-based search and intelligent product matching.

## üöÄ Features

### Core Functionality
- **Real-time scraping** of major grocery store websites
- **Location-based search** across multiple stores in a zipcode
- **Intelligent product matching** with confidence scores and alternatives
- **Store coverage mapping** by zipcode ranges
- **Query suggestions** and product synonyms
- **Enhanced product data** with categories and match types

### Supported Stores
- **Giant Eagle** - Pennsylvania, Ohio, West Virginia, Indiana, Maryland
- **Wegmans** - New York, Pennsylvania, New Jersey, Virginia, Maryland, Massachusetts, North Carolina
- **ALDI** - Nationwide coverage
- **Albertsons** - Nationwide coverage
- **ShopRite** - Northeast region

### Architecture Highlights
- **Location Service**: Zipcode-based store discovery (prepared for Perplexity Sonar integration)
- **Product Matcher**: Fuzzy matching and alternatives (prepared for vector search)
- **Enhanced Scraper**: Multi-store search with intelligent filtering
- **Confidence Scoring**: Product relevance scoring and filtering
- **Category Classification**: Automatic product categorization

## üèóÔ∏è Architecture Vision

This API is designed to evolve into a comprehensive grocery search platform:

### Current Implementation
- ‚úÖ Real-time scraping across multiple stores
- ‚úÖ Location-based store discovery
- ‚úÖ Intelligent product matching and alternatives
- ‚úÖ Confidence scoring and filtering
- ‚úÖ Query suggestions and synonyms

### Future Enhancements (Pinecone + Perplexity Sonar)
- ‚úÖ **Perplexity Sonar**: Dynamic store discovery and real-time store data
- üîÑ **Pinecone Integration**: Vector caching and semantic search
- üîÑ **Advanced Caching**: Intelligent result caching to reduce scraping overhead
- üîÑ **Semantic Understanding**: Deep product relationship mapping
- üîÑ **Dynamic Store Discovery**: Real-time store availability and services

## üöÄ Quick Start

### Prerequisites
- Python 3.7+
- Chrome/Chromium browser (for Selenium)

### Installation

1. **Clone the repository**
```bash
git clone <repository-url>
cd grocery-scraper-api
```

2. **Create virtual environment**
```bash
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

3. **Install dependencies**
```bash
pip install -r requirements.txt
```

4. **Run the API**
```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

The API will be available at `http://localhost:8000`

## üìö API Endpoints

### Core Endpoints

#### `GET /`
API information and available endpoints

#### `GET /health`
Health check with scraper status

#### `GET /stores`
List of supported stores with status

#### `POST /scrape`
Scrape products from a specific store
```json
{
  "query": "milk",
  "store": "gianteagle",
  "zipcode": "15213"
}
```

### Enhanced Location-Based Search

#### `POST /search/location`
Search across multiple stores in a location
```json
{
  "query": "almond milk",
  "zipcode": "15213",
  "radius_miles": 10,
  "max_results": 20,
  "include_alternatives": true,
  "min_confidence": 0.5
}
```

#### `GET /search/location`
GET version for easy testing
```
/search/location?query=milk&zipcode=15213&max_results=5
```

### Intelligence Endpoints

#### `GET /coverage`
Get store coverage by zipcode ranges

#### `GET /suggest?partial=mi`
Get query suggestions based on partial input

#### `GET /synonyms/{query}`
Get synonyms and alternatives for a product

#### `GET /services/{store_id}`
Get available services for a store (delivery, pickup, etc.)

### Perplexity Sonar Integration

The API now includes enhanced Perplexity Sonar integration for dynamic store discovery and real-time information retrieval.

#### `GET /sonar/status`
Check Sonar client status and configuration

#### `GET /sonar/stores/{zipcode}`
Discover stores in a zipcode using Perplexity Sonar
```
/sonar/stores/15213
```

#### `GET /sonar/store/{store_name}/details`
Get detailed store information via Sonar
```
/sonar/store/Giant Eagle/details?location=Pittsburgh, PA
```

#### `GET /sonar/products/search`
Search for products at a specific store using Sonar
```
/sonar/products/search?query=milk&store_name=Giant Eagle&location=Pittsburgh, PA
```

#### `GET /sonar/test/{zipcode}`
Test Sonar integration for a zipcode
```
/sonar/test/15213
```

## üîç Usage Examples

### Basic Store Search
```bash
curl "http://localhost:8000/scrape?query=milk&store=gianteagle&zipcode=15213"
```

### Location-Based Search
```bash
curl "http://localhost:8000/search/location?query=organic%20bread&zipcode=10001&max_results=10"
```

### Get Query Suggestions
```bash
curl "http://localhost:8000/suggest?partial=org"
```

### Get Product Synonyms
```bash
curl "http://localhost:8000/synonyms/milk"
```

### Sonar Store Discovery
```bash
curl "http://localhost:8000/sonar/stores/15213"
```

### Sonar Store Details
```bash
curl "http://localhost:8000/sonar/store/Giant%20Eagle/details?location=Pittsburgh,%20PA"
```

### Sonar Product Search
```bash
curl "http://localhost:8000/sonar/products/search?query=organic%20milk&store_name=Giant%20Eagle&location=Pittsburgh,%20PA"
```

## üìä Response Format

### Location Search Response
```json
{
  "success": true,
  "query": "milk",
  "zipcode": "15213",
  "stores_found": 5,
  "total_products": 20,
  "store_results": {
    "gianteagle": { /* store results */ },
    "wegmans": { /* store results */ }
  },
  "best_matches": [
    {
      "title": "Giant Eagle 2% Reduced Fat Milk",
      "product_name": "Giant Eagle 2% Reduced Fat Milk",
      "brand": "Giant",
      "price": "$3.99",
      "confidence_score": 0.9,
      "match_type": "exact",
      "categories": ["dairy"]
    }
  ],
  "alternatives": [ /* alternative products */ ],
  "search_metadata": {
    "search_duration_ms": 1250,
    "stores_searched": 5,
    "stores_with_results": 4,
    "total_products_found": 62,
    "products_after_filtering": 20,
    "min_confidence": 0.5,
    "alternatives_found": 3
  }
}
```

## üéØ Product Matching Features

### Confidence Scoring
- **1.0**: Exact match
- **0.9**: Contains match
- **0.7-0.8**: Similar match
- **<0.7**: Alternative match

### Match Types
- **exact**: Perfect match for the query
- **similar**: Close match with high confidence
- **alternative**: Related product or synonym

### Categories
Products are automatically categorized into:
- Dairy, Produce, Meat, Pantry, Bakery, Beverages, Snacks, Frozen

## üîß Configuration

### Store Coverage
Store coverage is configured in `scraper/location_service.py`:
```python
store_coverage = {
    "gianteagle": ["15000-16999", "43000-45999"],  # PA, OH
    "wegmans": ["10000-14999", "15000-16999"],     # NY, PA
    "aldi": ["00000-99999"],                       # Nationwide
}
```

### Product Synonyms
Product synonyms are configured in `scraper/product_matcher.py`:
```python
product_synonyms = {
    "milk": ["dairy", "milk alternative", "plant milk"],
    "bread": ["loaf", "sandwich bread", "artisan bread"],
}
```

## üîç Perplexity Sonar Integration

### Overview
The API now includes enhanced Perplexity Sonar integration that provides:

- **Dynamic Store Discovery**: Real-time discovery of grocery stores in any zipcode
- **Store Details**: Comprehensive store information including hours, services, and contact details
- **Product Search**: Real-time product availability and pricing information
- **Intelligent Caching**: Built-in caching to reduce API calls and improve performance
- **Error Handling**: Robust error handling with graceful fallbacks

### Features

#### Store Discovery
- Automatically finds grocery stores in any zipcode
- Extracts store names, addresses, and services
- Supports major chains: Giant Eagle, Wegmans, ALDI, Walmart, Target, Kroger, etc.
- Caches results for 1 hour to improve performance

#### Store Details
- Current store hours (day by day)
- Available services (delivery, pickup, curbside, in-store)
- Contact information (phone, website)
- Store address and features
- Real-time status updates

#### Product Search
- Search for products at specific stores
- Current pricing information (when available)
- Availability status
- Special offers and deals
- Product categories and departments

### Setup

1. **Get Perplexity API Key**
   - Sign up at [Perplexity AI](https://www.perplexity.ai/)
   - Navigate to API settings
   - Generate an API key

2. **Configure Environment**
   ```bash
   export PERPLEXITY_API_KEY="your-api-key-here"
   ```
   
   Or create a `.env` file:
   ```
   PERPLEXITY_API_KEY=your-api-key-here
   ```

3. **Test Integration**
   ```bash
   python test_sonar.py
   ```

### API Response Examples

#### Store Discovery Response
```json
{
  "zipcode": "15213",
  "stores_found": 5,
  "stores": [
    {
      "store_id": "gianteagle",
      "store_name": "Giant Eagle",
      "address": "123 Main St, Pittsburgh, PA 15213",
      "services": ["delivery", "pickup", "curbside"],
      "status": "active",
      "zipcode": "15213"
    }
  ],
  "source": "perplexity_sonar"
}
```

#### Store Details Response
```json
{
  "store_name": "Giant Eagle",
  "location": "Pittsburgh, PA",
  "details": {
    "hours": {
      "monday": "6:00 AM - 11:00 PM",
      "tuesday": "6:00 AM - 11:00 PM"
    },
    "services": ["delivery", "pickup", "curbside"],
    "contact": {
      "phone": "(412) 555-0123",
      "website": "https://www.gianteagle.com"
    },
    "address": "123 Main St, Pittsburgh, PA 15213",
    "features": ["pharmacy", "bakery", "deli"]
  },
  "source": "perplexity_sonar"
}
```

#### Product Search Response
```json
{
  "query": "organic milk",
  "store_name": "Giant Eagle",
  "location": "Pittsburgh, PA",
  "products_found": 3,
  "products": [
    {
      "name": "Organic Valley Whole Milk",
      "price": 4.99,
      "availability": "In stock"
    }
  ],
  "source": "perplexity_sonar"
}
```

### Error Handling

The Sonar integration includes comprehensive error handling:

- **API Key Issues**: Graceful handling of missing or invalid API keys
- **Rate Limiting**: Automatic handling of rate limit exceeded errors
- **Network Issues**: Timeout and connection error handling
- **Invalid Responses**: Fallback parsing for unexpected response formats
- **Cache Management**: Automatic cache invalidation and cleanup

### Performance Optimization

- **Caching**: Results cached for 1 hour to reduce API calls
- **Async Operations**: Non-blocking API calls for better performance
- **Timeout Management**: 45-second timeout for API requests
- **Batch Processing**: Efficient handling of multiple requests

## üöÄ Deployment

### Docker
```bash
docker build -t grocery-scraper-api .
docker run -p 8000:8000 grocery-scraper-api
```

### Environment Variables
- `PORT`: Server port (default: 8000)
- `GROQ_API_KEY`: For LLM-enhanced product extraction
- `PERPLEXITY_API_KEY`: For Perplexity Sonar integration
- `CHROMEDRIVER_PATH`: Custom ChromeDriver path

## üîÆ Future Roadmap

### Phase 1: Vector Search Integration
- [ ] Pinecone integration for semantic caching
- [ ] Vector embeddings for product similarity
- [ ] Intelligent result caching

### Phase 2: Dynamic Store Discovery
- ‚úÖ Perplexity Sonar integration
- ‚úÖ Real-time store availability
- ‚úÖ Dynamic store coverage updates

### Phase 3: Advanced Features
- [ ] Price comparison across stores
- [ ] Nutritional information extraction
- [ ] Recipe-based shopping lists
- [ ] Personalized recommendations

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## üìÑ License

This project is licensed under the MIT License.

## üÜò Support

For issues and questions:
- Check the `/health` endpoint for system status
- Review the `/docs` endpoint for interactive API documentation
- Open an issue on GitHub

---

**Note**: This API is designed for educational and research purposes. Please respect the terms of service of the grocery stores being scraped.
